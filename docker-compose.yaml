services:
  # ====================================================================
  # BACKEND - API REST
  # ====================================================================
  backend:
    build: ./backend
    container_name: finance_backend
    network_mode: host
    env_file:
      - ./backend/.env
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - NODE_ENV=development
      - DATABASE_URL=mongodb://localhost:27017,localhost:27018,localhost:27019/finance_app_db?replicaSet=rs0&retryWrites=true&w=majority
      - RABBIT_URL=amqp://localhost:5672
      - REDIS_URL=redis://localhost:6379
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4000/api/status || wget -qO- http://localhost:4000/api/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    depends_on:
      mongo1:
        condition: service_healthy
      mongo2:
        condition: service_healthy
      mongo3:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ====================================================================
  # WORKER - Processamento de jobs recorrentes
  # ====================================================================
  worker:
    build: ./backend
    container_name: finance_worker
    network_mode: host
    command: ["node", "dist/workers/recurringWorker.js"]
    env_file:
      - ./backend/.env
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - NODE_ENV=development
      - DATABASE_URL=mongodb://localhost:27017,localhost:27018,localhost:27019/finance_app_db?replicaSet=rs0&retryWrites=true&w=majority
      - RABBIT_URL=amqp://localhost:5672
      - REDIS_URL=redis://localhost:6379
    healthcheck:
      test: ["CMD", "sh", "-c", "kill -0 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    depends_on:
      mongo1:
        condition: service_healthy
      mongo2:
        condition: service_healthy
      mongo3:
        condition: service_healthy
      backend:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ====================================================================
  # BULK-WORKER - Processamento de operações em lote
  # ====================================================================
  bulk-worker:
    build: ./backend
    container_name: finance_bulk_worker
    network_mode: host
    command: ["node", "dist/workers/bulkWorker.js"]
    env_file:
      - ./backend/.env
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - NODE_ENV=development
      - DATABASE_URL=mongodb://localhost:27017,localhost:27018,localhost:27019/finance_app_db?replicaSet=rs0&retryWrites=true&w=majority
      - RABBIT_URL=amqp://localhost:5672
      - REDIS_URL=redis://localhost:6379
    healthcheck:
      test: ["CMD", "sh", "-c", "kill -0 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    depends_on:
      mongo1:
        condition: service_healthy
      mongo2:
        condition: service_healthy
      mongo3:
        condition: service_healthy
      backend:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ====================================================================
  # FRONTEND - Interface React
  # ====================================================================
  frontend:
    build: ./frontend
    container_name: finance_frontend
    network_mode: host
    env_file:
      - ./frontend/.env
    environment:
      - VITE_API_URL=http://localhost:4000
    depends_on:
      backend:
        condition: service_healthy

  # ====================================================================
  # MONGODB - Replica set (3 nodes) para DEV
  # ====================================================================
  mongo1:
    image: mongo:7
    container_name: finance_mongo1
    restart: unless-stopped
    network_mode: host
    command: ["mongod", "--bind_ip_all", "--replSet", "rs0", "--port", "27017"]
    volumes:
      - mongo1_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--port", "27017", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  mongo2:
    image: mongo:7
    container_name: finance_mongo2
    restart: unless-stopped
    network_mode: host
    command: ["mongod", "--bind_ip_all", "--replSet", "rs0", "--port", "27018"]
    volumes:
      - mongo2_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--port", "27018", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  mongo3:
    image: mongo:7
    container_name: finance_mongo3
    restart: unless-stopped
    network_mode: host
    command: ["mongod", "--bind_ip_all", "--replSet", "rs0", "--port", "27019"]
    volumes:
      - mongo3_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--port", "27019", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ====================================================================
  # MONGO INIT - Replica Set inicialization (idempotent)
  # ====================================================================
  mongo-init-replica:
    image: mongo:7
    network_mode: host
    depends_on:
      mongo1:
        condition: service_healthy
      mongo2:
        condition: service_healthy
      mongo3:
        condition: service_healthy
    entrypoint:
      [
        "sh",
        "-c",
        "for p in 27017 27018 27019; do until mongosh --quiet --host localhost:$p --eval \"db.adminCommand('ping')\"; do sleep 2; done; done; mongosh --quiet --host localhost:27017 --eval \"const cfg={ _id:'rs0', members:[{ _id:0, host:'localhost:27017' },{ _id:1, host:'localhost:27018' },{ _id:2, host:'localhost:27019' }]}; try { const status=rs.status(); if(status.ok===1 && status.members && status.members.length===3) { quit(0); } } catch(err) {} try { rs.initiate(cfg) } catch(e) { try { rs.reconfig(cfg,{ force:true }) } catch(err2) { print(err2); quit(1); } }\"",
      ]

  # ====================================================================
  # RABBITMQ - Message Broker
  # ====================================================================
  rabbitmq:
    image: rabbitmq:3-management
    container_name: finance_rabbitmq
    restart: unless-stopped
    network_mode: host
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_running"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # ====================================================================
  # REDIS - Cache
  # ====================================================================
  redis:
    image: redis:7
    container_name: finance_redis
    network_mode: host
    command: ["redis-server", "--protected-mode", "no", "--bind", "0.0.0.0"]
    restart: unless-stopped
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

volumes:
  mongo1_data:
  mongo2_data:
  mongo3_data:
  redis_data:
