services:
  # ====================================================================
  # BACKEND - API REST
  # ====================================================================
  backend:
    build: ./backend
    container_name: finance_backend
    ports:
      - "4000:4000"
    env_file:
      - ./backend/.env
    environment:
      - NODE_ENV=production
      - DATABASE_URL=mongodb://mongo:27017/finance_app_db
      - RABBIT_URL=amqp://rabbitmq:5672
      - REDIS_URL=redis://redis:6379
    networks:
      - finance_net
    # HEALTHCHECK para Docker Compose
    # Verifica se o container está saudável antes de marcar como "ready"
    # Docker usa isso para:
    # 1. Saber quando o container está realmente pronto (não apenas "running")
    # 2. Detectar se o processo travou (mesmo que container esteja UP)
    # 3. Orquestrar depends_on com condition: service_healthy
      # Comando executado dentro do container
      # curl -f: Fail silently (retorna exit code 22 se HTTP >= 400)
      # http://localhost:4000/api/health: Nosso endpoint customizado
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4000/api/status || wget -qO- http://localhost:4000/api/status"]
      
      # Intervalo entre health checks (quanto tempo esperar entre verificações)
      # 30s: Não precisa verificar constantemente, economiza CPU
      interval: 30s
      
      # Timeout para cada verificação (quanto tempo esperar por resposta)
      # 10s: Tempo suficiente para endpoint responder mesmo sob carga
      timeout: 10s
      
      # Quantas falhas consecutivas antes de marcar como "unhealthy"
      # 3: Tolera falhas temporárias (ex: spike de CPU)
      retries: 3
      
      # Período de grace antes de começar a verificar
      # 15s: Tempo para aplicação inicializar (carregar módulos, conectar DB)
      start_period: 15s
    # Só inicia após dependências estarem saudáveis
    depends_on:
      mongo:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ====================================================================
  # WORKER - Processamento de jobs recorrentes
  # ====================================================================
  worker:
    build: ./backend
    container_name: finance_worker
    command: ["node", "dist/workers/recurringWorker.js"]
    env_file:
      - ./backend/.env
    environment:
      - DATABASE_URL=mongodb://mongo:27017/finance_app_db
      - RABBIT_URL=amqp://rabbitmq:5672
      - REDIS_URL=redis://redis:6379
    networks:
      - finance_net
    # Worker não tem endpoint HTTP, então verificamos se processo está vivo
    # Usando kill -0 que apenas verifica se PID 1 existe (não mata o processo)
    healthcheck:
      # kill -0 <PID>: Verifica se processo existe sem matar
      # PID 1: Primeiro processo do container (nosso worker)
      # Exit code 0: Processo existe e está rodando
      test: ["CMD", "sh", "-c", "kill -0 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    # Só inicia se backend estiver HEALTHY (não apenas running)
    # Garante que worker não tenta processar jobs enquanto API está iniciando
    depends_on:
      backend:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ====================================================================
  # BULK-WORKER - Processamento de operações em lote
  # ====================================================================
  bulk-worker:
    build: ./backend
    container_name: finance_bulk_worker
    command: ["node", "dist/workers/bulkWorker.js"]
    env_file:
      - ./backend/.env
    environment:
      - DATABASE_URL=mongodb://mongo:27017/finance_app_db
      - RABBIT_URL=amqp://rabbitmq:5672
      - REDIS_URL=redis://redis:6379
    networks:
      - finance_net
    healthcheck:
      test: ["CMD", "sh", "-c", "kill -0 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    depends_on:
      backend:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ====================================================================
  # FRONTEND - Interface React
  # ====================================================================
  frontend:
    build: ./frontend
    container_name: finance_frontend
    ports:
      - "5173:5173"
    networks:
      - finance_net
    env_file:
      - ./frontend/.env
    environment:
      - VITE_API_URL=http://localhost:4000
    # Frontend só inicia quando backend estiver SAUDÁVEL
    # Evita tela em branco ou erros de "Cannot connect to API"
    depends_on:
      backend:
        condition: service_healthy

  # ====================================================================
  # MONGODB - Banco de dados
  # ====================================================================
  mongo:
    image: mongo:7
    container_name: finance_mongo
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - finance_net
    # MongoDB tem healthcheck nativo via mongosh
    # Verifica se o daemon está aceitando conexões
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ====================================================================
  # RABBITMQ - Message Broker
  # ====================================================================
  rabbitmq:
    image: rabbitmq:3-management
    container_name: finance_rabbitmq
    restart: unless-stopped
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - finance_net
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s

  # ====================================================================
  # REDIS - Cache
  # ====================================================================
  redis:
    image: redis:7
    container_name: finance_redis
    command: ["redis-server", "--protected-mode", "no", "--bind", "0.0.0.0"]
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - finance_net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

volumes:
  mongo_data:
  redis_data:


networks:
  finance_net:
    driver: bridge
