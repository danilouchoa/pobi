services:
  # ====================================================================
  # BACKEND - API REST
  # ====================================================================
  backend:
    build: ./backend
    container_name: finance_backend
    ports:
      - "4000:4000"
    env_file:
      - ./backend/.env
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - NODE_ENV=development
      - DATABASE_URL=mongodb://mongo1:27017,mongo2:27017,mongo3:27017/finance_app_db?replicaSet=rs0
      - RABBIT_URL=amqp://rabbitmq:5672
      - REDIS_URL=redis://host.docker.internal:6379
    networks:
      - finance_net
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4000/api/status || wget -qO- http://localhost:4000/api/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    depends_on:
      mongo1:
        condition: service_healthy
      mongo2:
        condition: service_healthy
      mongo3:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ====================================================================
  # WORKER - Processamento de jobs recorrentes
  # ====================================================================
  worker:
    build: ./backend
    container_name: finance_worker
    command: ["node", "dist/workers/recurringWorker.js"]
    env_file:
      - ./backend/.env
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - NODE_ENV=development
      - DATABASE_URL=mongodb://mongo1:27017,mongo2:27017,mongo3:27017/finance_app_db?replicaSet=rs0
      - RABBIT_URL=amqp://rabbitmq:5672
      - REDIS_URL=redis://host.docker.internal:6379
    networks:
      - finance_net
    healthcheck:
      test: ["CMD", "sh", "-c", "kill -0 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    depends_on:
      mongo1:
        condition: service_healthy
      mongo2:
        condition: service_healthy
      mongo3:
        condition: service_healthy
      backend:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ====================================================================
  # BULK-WORKER - Processamento de operações em lote
  # ====================================================================
  bulk-worker:
    build: ./backend
    container_name: finance_bulk_worker
    command: ["node", "dist/workers/bulkWorker.js"]
    env_file:
      - ./backend/.env
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - NODE_ENV=development
      - DATABASE_URL=mongodb://mongo1:27017,mongo2:27017,mongo3:27017/finance_app_db?replicaSet=rs0
      - RABBIT_URL=amqp://rabbitmq:5672
      - REDIS_URL=redis://host.docker.internal:6379
    networks:
      - finance_net
    healthcheck:
      test: ["CMD", "sh", "-c", "kill -0 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    depends_on:
      mongo1:
        condition: service_healthy
      mongo2:
        condition: service_healthy
      mongo3:
        condition: service_healthy
      backend:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ====================================================================
  # FRONTEND - Interface React
  # ====================================================================
  frontend:
    build: ./frontend
    container_name: finance_frontend
    ports:
      - "5173:5173"
    networks:
      - finance_net
    env_file:
      - ./frontend/.env
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - VITE_API_URL=http://localhost:4000
    depends_on:
      backend:
        condition: service_healthy

  # ====================================================================
  # MONGODB - Replica Set (3 nós)
  # ====================================================================
  mongo1:
    image: mongo:7
    container_name: finance_mongo1
    restart: unless-stopped
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all"]
    ports:
      - "27017:27017"
    volumes:
      - mongo1_data:/data/db
    networks:
      - finance_net
    healthcheck:
      test: ["CMD-SHELL", "pgrep mongod >/dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  mongo2:
    image: mongo:7
    container_name: finance_mongo2
    restart: unless-stopped
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all"]
    volumes:
      - mongo2_data:/data/db
    networks:
      - finance_net
    healthcheck:
      test: ["CMD-SHELL", "pgrep mongod >/dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  mongo3:
    image: mongo:7
    container_name: finance_mongo3
    restart: unless-stopped
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all"]
    volumes:
      - mongo3_data:/data/db
    networks:
      - finance_net
    healthcheck:
      test: ["CMD-SHELL", "pgrep mongod >/dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  mongo-init-replica:
    image: mongo:7
    restart: "no"
    depends_on:
      mongo1:
        condition: service_started
      mongo2:
        condition: service_started
      mongo3:
        condition: service_started
    networks:
      - finance_net
    entrypoint:
      - bash
      - -c
      - |
        set -e

        echo "[mongo-init] Waiting 15s for MongoDB nodes to start..."
        sleep 15

        echo "[mongo-init] Ensuring replica set rs0 is initiated..."
        mongosh --host mongo1:27017 --quiet <<'EOF'
          try {
            const status = rs.status();
            if (status.ok === 1) {
              print("Replica set already initialized (state: " + status.myState + ").");
              quit(0);
            }
          } catch (e) {
            if (e.codeName === "NotYetInitialized") {
              rs.initiate({
                _id: "rs0",
                members: [
                  { _id: 0, host: "mongo1:27017" },
                  { _id: 1, host: "mongo2:27017" },
                  { _id: 2, host: "mongo3:27017" }
                ]
              });
              print("Replica set initiation command issued.");
              quit(0);
            }
            printjson(e);
            quit(1);
          }
        EOF

        echo "[mongo-init] Waiting for PRIMARY state (max ~60s)..."
        for i in {1..30}; do
          if mongosh --host mongo1:27017 --quiet --eval "const s = rs.status(); if (s.ok === 1 && s.myState === 1) { quit(0); } quit(1);" >/dev/null 2>&1; then
            echo "[mongo-init] PRIMARY READY."
            exit 0
          fi
          echo "[mongo-init] Replica set not PRIMARY yet. Retry $i/30 in 2s..."
          sleep 2
        done

        echo "[mongo-init] Timed out waiting for PRIMARY state."
        exit 1

  # ====================================================================
  # RABBITMQ - Message Broker
  # ====================================================================
  rabbitmq:
    image: rabbitmq:3-management
    container_name: finance_rabbitmq
    restart: unless-stopped
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - finance_net
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_running"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # ====================================================================
  # REDIS - Cache
  # ====================================================================
  redis:
    image: redis:7
    container_name: finance_redis
    command: ["redis-server", "--protected-mode", "no", "--bind", "0.0.0.0"]
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - finance_net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

volumes:
  mongo1_data:
  mongo2_data:
  mongo3_data:
  redis_data:

networks:
  finance_net:
    driver: bridge
