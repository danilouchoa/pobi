{
  "codex_memory": {
    "project": "Finance App Project",
    "version": "v5.7 (An√°lise de Seguran√ßa e Resili√™ncia Integrada)",
    "description": "Aplica√ß√£o fullstack de controle financeiro (React + Express + Prisma + MongoDB + RabbitMQ + Upstash Redis), com foco em modulariza√ß√£o, seguran√ßa e resili√™ncia.",
    "milestones": [
      {
        "id": 9,
        "tag": "[FE] Toasts & Empty States",
        "status": "üü° Em Execu√ß√£o (Codex)",
        "summary": "Adicionar feedbacks visuais consistentes (sucesso/erro) e placeholders de listas vazias para melhorar a UX em CRUDs, com documenta√ß√£o explicativa em todo o c√≥digo gerado.",
        "notes": [
          "Exemplo de configura√ß√£o docker-compose (YAML):\nservices:\n  mongo:\n    image: mongo:7\n    # Remover binding host 27017 (use apenas rede interna do compose)\n    # ports:\n    #   - \"27017:27017\"\n\n  backend:\n    build: ./backend\n    # Se precisar expor s√≥ para host em outra porta, altere 4000 para outra porta livre (ex.: 14000)\n    ports:\n      - \"14000:4000\"\n    # ...existing code...",
          "Implementar notistack com provedores no App; padronizar mensagens por tipo de opera√ß√£o.",
          "Criar hook useToast() com fun√ß√µes success/error/info/warning e coment√°rios explicando prop√≥sito, uso e integra√ß√£o.",
          "Criar componente EmptyState (MUI) com CTA, t√≠tulo e descri√ß√£o ‚Äî totalmente comentado sobre seu papel na UX e funcionamento interno.",
          "Criar utilit√°rio mapBackendError() traduzindo c√≥digos t√©cnicos em mensagens leg√≠veis; comentar cada caso de erro e como √© tratado.",
          "Integrar toasts e EmptyStates nas telas de CRUD existentes, com coment√°rios em cada ponto de uso explicando a a√ß√£o do usu√°rio e o feedback exibido.",
          "Incluir l√≥gica para prevenir duplicidade de toasts (chave √∫nica + debounce), com coment√°rios detalhando a mitiga√ß√£o e o racional.",
          "Crit√©rios de aceite: toasts em create/update/delete, placeholders exibidos em listas vazias, nenhum console error, e todos os arquivos novos/alterados devidamente comentados.",
          "Riscos: duplicidade de toasts; mitigar com chaves √∫nicas e debounce.",
          "Todos os c√≥digos gerados devem conter coment√°rios explicativos sobre prop√≥sito, funcionamento e integra√ß√£o com o restante do app."
        ]
      },
      {
        "id": 17,
        "tag": "[DX] Storybook",
        "status": "üü° Planejado (NOVO)",
        "summary": "Documentar componentes MUI e cen√°rios de UI isolados para acelerar desenvolvimento e QA.",
        "notes": [
          "Configurar Storybook com suporte ao tema MUI e mocks de dados.",
          "Criar stories para MonthNavigator, cards/KPIs e formul√°rios base.",
          "Adicionar controles (args) e docs autom√°ticas.",
          "Crit√©rios de aceite: stories executando via npm run storybook sem warnings.",
          "Riscos: drift com produ√ß√£o; mitigar com stories at√¥micos e knobs."
        ]
      },
      {
        "id": 10,
        "tag": "[DX] Healthchecks e Docker Prod",
        "status": "üü° Planejado",
        "summary": "Aprimorar observabilidade e robustez de execu√ß√£o em cont√™ineres.",
        "notes": [
          "Endpoint /api/health e script health:db (ping Mongo).",
          "Healthcheck no docker-compose para backend/worker.",
          "Otimizar Dockerfile (non-root opcional, npm ci, prune caches).",
          "Crit√©rios de aceite: docker compose up est√°vel com health=healthy.",
          "Riscos: falsos positivos; mitigar com checks que consultem depend√™ncias reais."
        ]
      },
      {
        "id": 11,
        "tag": "[Security] Valida√ß√£o de Rota (Zod)",
        "status": "üü° Planejado (NOVO)",
        "summary": "Validar entrada de dados (body/query/params) em todas as rotas para reduzir erros e vetores de abuso.",
        "notes": [
          "Criar backend/src/schemas/* com Zod por recurso (expense, origin, auth...).",
          "Middleware gen√©rico de valida√ß√£o com mensagens padronizadas.",
          "Atualizar rotas para usar schemas antes de services.",
          "Crit√©rios de aceite: requisi√ß√µes inv√°lidas retornam 400 com detalhes; logs sem stack-trace de valida√ß√£o.",
          "Riscos: quebra silenciosa; mitigar com smoke tests e feature flags por rota."
        ]
      },
      {
        "id": 12,
        "tag": "[Security] Rate Limiting",
        "status": "üü° Planejado (NOVO)",
        "summary": "Proteger endpoints cr√≠ticos de brute force/DoS com limites por IP/rota.",
        "notes": [
          "express-rate-limit: authLimiter (10 req/10min) e apiLimiter (100 req/15min).",
          "Aplicar cabe√ßalhos Retry-After e respostas JSON padr√£o.",
          "Adicionar m√©tricas simples (contadores) para monitorar hits.",
          "Crit√©rios de aceite: limites efetivos em /auth/* e /api/*; sem bloqueios falsos em uso normal.",
          "Riscos: proxies/nat; mitigar com confian√ßa de IPs ou X-Forwarded-For conforme infra."
        ]
      },
      {
        "id": 16,
        "tag": "[DX] Testes Automatizados",
        "status": "üü° Planejado (NOVO)",
        "summary": "Cobertura unit√°ria e de integra√ß√£o para √°reas cr√≠ticas e novas regras de fatura.",
        "notes": [
          "Backend: Vitest + Supertest para services e rotas (auth, expenses, worker).",
          "Frontend: RTL para componentes e hooks com QueryClientProvider.",
          "Cobrir deriveBillingMonth() e adjustToBusinessDay() (fechamento no WE, virada, NEXT/PREVIOUS).",
          "Crit√©rios de aceite: CI roda com cobertura m√≠nima 80% nas √°reas cr√≠ticas.",
          "Riscos: flakiness; mitigar com seeds determin√≠sticos e mocks de clock."
        ]
      },
      {
        "id": 0,
        "tag": "[BUG] Fatura de Cart√£o (closingDay + dia √∫til + billingMonth)",
        "status": "üü° Planejado (NOVO)",
        "summary": "Classificar despesas de cart√£o pela fatura correta com base no dia de fechamento (ajustado para dia √∫til), gravando billingMonth.",
        "notes": [
          "Schema: Origin.closingDay (Int) e billingRolloverPolicy; Expense.billingMonth (YYYY-MM) + √≠ndice.",
          "Helpers: deriveBillingMonth(txDate, closingDay, policy) e adjustToBusinessDay().",
          "API: GET /api/expenses suporta mode=billing; muta√ß√µes preenchem billingMonth quando origin.type='Cart√£o'.",
          "Redis: chaves por billingMonth para cart√µes; invalidar em muta√ß√µes.",
          "Backfill: script para preencher billingMonth retroativo.",
          "Crit√©rios de aceite: lan√ßamento 08/11 no cart√£o (fech. 09 com WE‚Üísegunda) cai em fatura de 12/2025 automaticamente.",
          "Riscos: cart√µes sem closingDay; retornar 422 e guiar configura√ß√£o."
        ]
      },
      {
        "id": 14,
        "tag": "[Resilience] Dead Letter Queue (DLQ)",
        "status": "üü° Planejado (NOVO)",
        "summary": "Segregar mensagens irrecuper√°veis para an√°lise e reprocessamento seguro.",
        "notes": [
          "DLQ acoplada √† recurring-jobs; nack com requeue=false em erros permanentes.",
          "M√©tricas b√°sicas de taxa de dead-letter.",
          "Crit√©rios de aceite: mensagens inv√°lidas n√£o travam a fila principal.",
          "Riscos: descarte indevido; mitigar com policies e reten√ß√£o tempor√°ria."
        ]
      },
      {
        "id": 15,
        "tag": "[Refactor] Service/Repository Layer",
        "status": "üü° Planejado (NOVO)",
        "summary": "Separar responsabilidades em tr√™s camadas para clareza, testes e evolu√ß√£o segura.",
        "notes": [
          "Routes: valida√ß√£o + orquestra√ß√£o; Services: regras; Repositories: Prisma-only.",
          "Inje√ß√£o de depend√™ncia para facilitar mocks nos testes.",
          "Crit√©rios de aceite: rotas finas; services sem import de Prisma.",
          "Riscos: refator parcelado; mitigar com feature toggles e su√≠te de testes (#16)."
        ]
      },
      {
        "id": 13,
        "tag": "[Security] Auth httpOnly Cookies",
        "status": "üü° Planejado (NOVO)",
        "summary": "Trocar armazenamento de tokens para cookies httpOnly/sameSite, reduzindo superf√≠cie XSS.",
        "notes": [
          "Login entrega JWT via cookie httpOnly; logout limpa cookie.",
          "Axios withCredentials; refresh token seguro; access em mem√≥ria.",
          "Crit√©rios de aceite: rotas autenticadas funcionam sem localStorage.",
          "Riscos: CORS e dom√≠nio; mitigar com configura√ß√£o rigorosa e ambiente controlado."
        ]
      },
      {
        "id": 18,
        "tag": "[Security] Autentica√ß√£o Avan√ßada (MFA + Google Login)",
        "status": "üü° Planejado (NOVO)",
        "summary": "Adicionar MFA via Resend (OTP) e login social Google OAuth2 com fluxo completo de tokens.",
        "notes": [
          "Rotas: /auth/register, /auth/login, /auth/refresh, /auth/logout, /auth/resend, /auth/google.",
          "Cookies httpOnly para refresh; access token em mem√≥ria; interceptors Axios.",
          "Front: MFAForm e bot√£o Google; backend: valida√ß√µes de estado/nonce.",
          "Crit√©rios de aceite: MFA opcional funcional; Google login end-to-end.",
          "Riscos: fluxo OAuth mal configurado; mitigar com testes em sandbox e logs detalhados."
        ]
      },
      {
        "id": 5,
        "tag": "[API] √çndices e filtros UTC",
        "status": "üü¢ Implementado",
        "summary": "Normalizar consultas mensais por UTC para evitar desvios de timezone.",
        "notes": [
          "@@index([userId, date]) e range por Date.UTC em filtros.",
          "Crit√©rios de aceite: mesma query retorna os mesmos itens independente de TZ do host.",
          "Riscos: dados legados com TZ local; mitigado por convers√£o centralizada."
        ]
      },
      {
        "id": 6,
        "tag": "[FE] MUI Only Theme",
        "status": "üü¢ Implementado",
        "summary": "Unificar design system em MUI e remover res√≠duos de Tailwind.",
        "notes": [
          "ThemeProvider central; paleta/tipografia padronizadas.",
          "Crit√©rios de aceite: nenhuma classe Tailwind ativa; UI consistente.",
          "Riscos: regress√µes visuais; mitigar com verifica√ß√£o manual das principais telas."
        ]
      },
      {
        "id": 7,
        "tag": "[FE] Hooks Tipados + Query Cache",
        "status": "üü¢ Conclu√≠do",
        "summary": "Refatorar useFinanceApp em hooks modulares com TanStack Query e servi√ßos REST tipados.",
        "notes": [
          "useExpenses/useCatalogs/useSalary + Query Keys centralizadas.",
          "Axios com interceptors; tipagem de payloads/DTOs.",
          "Crit√©rios de aceite: cache por m√™s, invalida√ß√£o ap√≥s muta√ß√µes; zero acesso a LocalStorage.",
          "Riscos: chaves inconsistentes; mitigado por queryKeys.ts."
        ]
      },
      {
        "id": 8,
        "tag": "[FE/BE] Navega√ß√£o mensal + Cache Redis + Build Estabilizado",
        "status": "üü¢ Conclu√≠do (Valida√ß√£o Final OK)",
        "summary": "UX de navega√ß√£o temporal suave, cache distribu√≠do Redis e build Docker multi-stage est√°vel com Prisma.",
        "notes": [
          "MonthNavigator com Framer Motion; integra√ß√£o useFinanceApp.",
          "Upstash Redis por usu√°rio/m√™s e invalidation p√≥s-mutation.",
          "Docker: prisma generate no builder; c√≥pia de .prisma para runtime.",
          "Crit√©rios de aceite: logs com [CACHE HIT/MISS]; containers healthy.",
          "Riscos: WSL1; mitigar executando build em WSL2/Docker."
        ]
      },
      {
        "id": 4,
        "tag": "[Worker] RabbitMQ Robustness",
        "status": "üü¢ Conclu√≠do",
        "summary": "Resili√™ncia no processamento ass√≠ncrono de jobs de recorr√™ncia.",
        "notes": [
          "Reconex√£o com backoff, prefetch(10), ConfirmChannel, shutdown limpo.",
          "Crit√©rios de aceite: worker permanece est√°vel em reconex√µes.",
          "Riscos: mensagens venenosas; mitiga√ß√£o futura com DLQ (#14)."
        ]
      },
      {
        "id": 3,
        "tag": "[API] Security & Config ENV",
        "status": "üü¢ Conclu√≠do",
        "summary": "Endurecer configura√ß√£o e headers de seguran√ßa na API.",
        "notes": [
          "Zod para ENVs cr√≠ticos; Helmet e CORS din√¢mico.",
          "Crit√©rios de aceite: boot falha sem ENVs; headers presentes.",
          "Riscos: CORS mal configurado; mitigar com allowlist por ambiente."
        ]
      },
      {
        "id": 2,
        "tag": "[DB] Float ‚Üí String precision",
        "status": "üü¢ Conclu√≠do",
        "summary": "Evitar erros de arredondamento em valores monet√°rios.",
        "notes": [
          "Valores monet√°rios como string + coer√ß√µes nos helpers.",
          "Crit√©rios de aceite: compara√ß√£o monet√°ria determin√≠stica.",
          "Riscos: parsing negligenciado; mitigado em helpers centralizados."
        ]
      },
      {
        "id": 1,
        "tag": "[BUG] Replica√ß√£o e idempot√™ncia",
        "status": "üü¢ Resolvido",
        "summary": "Eliminar duplica√ß√µes de recorrentes por meio de fingerprint √∫nico.",
        "notes": [
          "√çndice √∫nico por fingerprint + backfill idempotente.",
          "Crit√©rios de aceite: nenhuma duplicidade em replays.",
          "Riscos: colis√£o de fingerprint; mitigado com sal e campos chave."
        ]
      }
    ],
    "last_action": "Instru√ß√µes detalhadas para Codex executando a Milestone #9 com coment√°rios explicativos adicionadas.",
    "next_steps": [
      "Codex executar√° a Milestone #9 (Toasts & Empty States) com c√≥digo comentado.",
      "Executar Milestone 17 (Storybook) como quick win subsequente.",
      "Implementar 10/11/12/16 para elevar qualidade/seguran√ßa e dar base ao Milestone 0.",
      "Entregar Milestone 0 (billingMonth) com backfill e testes.",
      "Planejar 14/15 (resili√™ncia/arquitetura) e 13/18 (autentica√ß√£o segura e avan√ßada)."
    ],
    "commit_template": "‚Ä¢ [Feature/Refactor/Fix] Descri√ß√£o da mudan√ßa.\n‚Ä¢ Relacionado ao(s) Milestone(s): #[ID]"
  }
}
