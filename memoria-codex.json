{
  "codex_memory": {
    "project": "Finance App Project",
    "version": "v6.3.0 (Auth httpOnly Cookies - Seguran√ßa Aprimorada)",
    "description": "Aplica√ß√£o fullstack de controle financeiro (React + Express + Prisma + MongoDB + RabbitMQ + Upstash Redis + httpOnly Cookies), com foco em modulariza√ß√£o, seguran√ßa, resili√™ncia, valida√ß√£o robusta e autentica√ß√£o segura.",
    "milestones": [
      {
        "id": 9,
        "tag": "[FE] Toasts & Empty States",
        "status": "üü¢ Conclu√≠do",
        "summary": "Feedbacks visuais consistentes (toasts) e placeholders de listas vazias (empty states) implementados em todas as telas CRUD, com c√≥digo totalmente documentado.",
        "notes": [
          "‚úÖ notistack instalado e SnackbarProvider configurado globalmente (top-right, max 3, 3s duration)",
          "‚úÖ Hook useToast() criado com success/error/info/warning e preven√ß√£o de duplicidade (debounce 2s + timestamp)",
          "‚úÖ Componente EmptyState.tsx (MUI) com props title/description/ctaLabel/onCtaClick/icon",
          "‚úÖ mapBackendError() traduzindo c√≥digos t√©cnicos (E_VALIDATION, E_DUPLICATE, etc) em mensagens leg√≠veis",
          "‚úÖ Toasts integrados em Lancamentos (5 opera√ß√µes), Cadastros (7 opera√ß√µes), Sal√°rio (2 opera√ß√µes)",
          "‚úÖ EmptyStates integrados: Lancamentos (1), Categorias (1), Origens (1), Devedores (1)",
          "‚úÖ 100% do c√≥digo comentado com JSDoc e documenta√ß√£o inline",
          "‚úÖ Crit√©rios de aceite: 14 opera√ß√µes com toasts, 4 empty states, zero erros console",
          "‚úÖ Documento completo: MILESTONE_9_COMPLETE.md com arquitetura e exemplos"
        ]
      },
      {
        "id": 17,
        "tag": "[DX] Storybook",
        "status": "ÔøΩ Conclu√≠do",
        "summary": "Storybook configurado com tema MUI, stories reais para MonthNavigator, KPI e EmptyState, sem exemplos quebrados.",
        "notes": [
          "‚úÖ Storybook 10.x com Vite e ThemeProvider global",
          "‚úÖ Stories reais: MonthNavigator, KPI, EmptyState",
          "‚úÖ Remo√ß√£o de exemplos quebrados",
          "‚úÖ Zero warnings/erros no build",
          "‚úÖ Crit√©rios de aceite: stories reais, tema aplicado, sem exemplos quebrados"
        ]
      },
      {
        "id": 14,
        "tag": "[BE] Dead Letter Queue (DLQ)",
        "status": "üü¢ Conclu√≠do",
        "summary": "DLQ implementada no RabbitMQ com retry, backoff, endpoints admin e integra√ß√£o nos workers.",
        "notes": [
          "‚úÖ DLQ via dead-letter-exchange e argumentos de fila",
          "‚úÖ Retry autom√°tico com backoff exponencial",
          "‚úÖ Endpoints admin: /api/dlq/stats, /api/dlq/messages, /api/dlq/reprocess/:id, /api/dlq/purge",
          "‚úÖ Prote√ß√£o JWT nos endpoints",
          "‚úÖ Logs detalhados de falhas e reprocessamentos",
          "‚úÖ Workers bulk/recurring integrados com DLQ",
          "‚úÖ Crit√©rios de aceite: mensagens na DLQ ap√≥s retries, admin funcional, testes manuais"
        ]
      },
      {
        "id": 10,
        "tag": "[DX] Healthchecks e Docker Prod",
        "status": "üü¢ Conclu√≠do",
        "summary": "Aprimorar observabilidade e robustez de execu√ß√£o em cont√™ineres com healthchecks completos.",
        "notes": [
          "‚úÖ Endpoint /api/health: Verifica Mongo (ping), Redis (PING) e RabbitMQ (connect+channel)",
          "‚úÖ Retorna JSON com status, uptime, lat√™ncia de cada depend√™ncia",
          "‚úÖ Status HTTP: 200 (ok) | 503 (unhealthy/degraded)",
          "‚úÖ Script health:db (check-db.ts): Verifica√ß√£o standalone do MongoDB com output detalhado",
          "‚úÖ Healthcheck Docker backend: curl -f http://localhost:4000/api/health (interval: 30s)",
          "‚úÖ Healthcheck Docker workers: kill -0 1 (verifica se PID 1 est√° vivo)",
          "‚úÖ Healthcheck Docker mongo: mongosh --eval 'db.adminCommand(ping)'",
          "‚úÖ Depends_on com condition: service_healthy - workers s√≥ iniciam ap√≥s backend healthy",
          "‚úÖ Frontend depende de backend healthy - evita erros de conex√£o",
          "‚úÖ Dockerfile: curl instalado no stage runtime para healthchecks",
          "‚úÖ Todos os containers com STATUS=healthy validados via docker ps",
          "‚úÖ Endpoint /ready: Readiness probe para compatibilidade futura com Kubernetes"
        ]
      },
      {
        "id": 11,
        "tag": "[Security] Valida√ß√£o de Rota (Zod)",
        "status": "üü¢ Conclu√≠do",
        "summary": "Sistema completo de valida√ß√£o de entrada (body/query/params) usando Zod, com middleware gen√©rica, schemas por recurso, feature flag e logs limpos.",
        "notes": [
          "‚úÖ 5 schemas criados: expense (180L), origin (160L), auth (80L), salary (100L), catalog (90L)",
          "‚úÖ Middleware validation.ts (290L): aceita body/query/params, retorna 400 padronizado, respeita VALIDATION_ENABLED",
          "‚úÖ Formato de erro: { error, message, details: [{ field, message }] } - sem stack-trace",
          "‚úÖ Feature flag VALIDATION_ENABLED no config.ts (default: true, permite rollback)",
          "‚úÖ 18 rotas validadas: expenses (4), origins (4), auth (2), salary (4), debtors (4)",
          "‚úÖ Valida√ß√µes monet√°rias: string formato '0.00' com regex /^\\d+\\.\\d{2}$/",
          "‚úÖ Valida√ß√µes de datas: z.coerce.date() para ISO 8601, ranges validados",
          "‚úÖ Valida√ß√µes de IDs: ObjectId MongoDB (24 chars hex) com regex",
          "‚úÖ Valida√ß√£o condicional: closingDay obrigat√≥rio quando type='Cart√£o'",
          "‚úÖ Seguran√ßa: .strict() rejeita campos extras (previne mass assignment)",
          "‚úÖ Telemetria: contadores validationFailures (por rota) e validationFailuresByField",
          "‚úÖ Fun√ß√£o getValidationMetrics() para debugging e monitoramento",
          "‚úÖ Logs n√≠vel 'warn' SEM stack-trace para erros esperados de valida√ß√£o",
          "‚úÖ Conven√ß√µes: createXxxSchema, updateXxxSchema (.partial()), queryXxxSchema, idParamSchema",
          "‚úÖ Documenta√ß√£o completa consolidada no README.md (se√ß√£o Milestone #11)",
          "üêõ v6.2.1 FIX: queryExpenseSchema ajustado para aceitar mode=calendar, year, limit=1000 (compatibilidade frontend)",
          "üêõ v6.2.1 FIX: Middleware corrigido para n√£o sobrescrever req.query (read-only no Express)",
          "‚úÖ v6.2.1 TEST: Todas as rotas validadas retornando 200 OK (expenses, origins, salary, debtors)",
          "‚úÖ v6.2.1 STATUS: Sistema 100% funcional em produ√ß√£o sem erros 400/500"
        ]
      },
      {
        "id": 13,
        "tag": "[Security] Auth httpOnly Cookies",
        "status": "üü¢ Conclu√≠do",
        "summary": "Migra√ß√£o de localStorage (vulner√°vel a XSS) para cookies httpOnly + tokens em mem√≥ria, com refresh autom√°tico e valida√ß√£o real de credenciais.",
        "notes": [
          "‚úÖ Arquitetura de 2 tokens: Access Token (15min, mem√≥ria) + Refresh Token (7d, cookie httpOnly)",
          "‚úÖ Backend: 4 endpoints (login, register, refresh, logout) com bcrypt + JWT",
          "‚úÖ Cookies httpOnly: secure (HTTPS prod), sameSite: strict (previne CSRF), inacess√≠vel via JS",
          "‚úÖ Valida√ß√£o real: bcrypt.compare() para senhas, mensagens gen√©ricas (previne enumera√ß√£o)",
          "‚úÖ Auto-refresh: Frontend intercepta 401, chama /auth/refresh automaticamente",
          "‚úÖ CORS: credentials: true no backend + withCredentials: true no frontend",
          "‚úÖ cookie-parser: Instalado no backend para ler req.cookies",
          "‚úÖ Logs seguros: Login success/fail com email/IP (SEM senha/token)",
          "‚úÖ Frontend: Token em mem√≥ria (state), user cacheado (localStorage), logout chama backend",
          "‚úÖ Testes: register, login, refresh, logout, credenciais inv√°lidas - TODOS PASSANDO",
          "‚úÖ Breaking change: Usu√°rios precisam fazer login novamente (tokens antigos inv√°lidos)",
          "‚úÖ Documenta√ß√£o: 1000+ linhas no README com diagramas, fluxos, troubleshooting",
          "‚úÖ Seguran√ßa: XSS prevenido (httpOnly), CSRF prevenido (sameSite: strict)",
          "‚úÖ Depend√™ncias: cookie-parser@1.4.6 + @types/cookie-parser@1.4.7"
        ]
      },
      {
        "id": 11,
        "tag": "[Security] Valida√ß√£o de Rota (Zod)",
        "status": "üü° Planejado (NOVO)",
        "summary": "Validar entrada de dados (body/query/params) em todas as rotas para reduzir erros e vetores de abuso.",
        "notes": [
          "Criar backend/src/schemas/* com Zod por recurso (expense, origin, auth...).",
          "Middleware gen√©rico de valida√ß√£o com mensagens padronizadas.",
          "Atualizar rotas para usar schemas antes de services.",
          "Crit√©rios de aceite: requisi√ß√µes inv√°lidas retornam 400 com detalhes; logs sem stack-trace de valida√ß√£o.",
          "Riscos: quebra silenciosa; mitigar com smoke tests e feature flags por rota."
        ]
      },
      {
        "id": 16,
        "tag": "[DX] Testes Automatizados",
        "status": "üü° Planejado (NOVO)",
        "summary": "Cobertura unit√°ria e de integra√ß√£o para √°reas cr√≠ticas e novas regras de fatura.",
        "notes": [
          "Backend: Vitest + Supertest para services e rotas (auth, expenses, worker).",
          "Frontend: RTL para componentes e hooks com QueryClientProvider.",
          "Cobrir deriveBillingMonth() e adjustToBusinessDay() (fechamento no WE, virada, NEXT/PREVIOUS).",
          "Crit√©rios de aceite: CI roda com cobertura m√≠nima 80% nas √°reas cr√≠ticas.",
          "Riscos: flakiness; mitigar com seeds determin√≠sticos e mocks de clock."
        ]
      },
      {
        "id": 0,
        "tag": "[BUG] Fatura de Cart√£o (closingDay + dia √∫til + billingMonth)",
        "status": "üü¢ Conclu√≠do (Backend)",
        "summary": "Classificar despesas de cart√£o pela fatura correta com base no dia de fechamento (ajustado para dia √∫til), gravando billingMonth automaticamente.",
        "notes": [
          "‚úÖ Schema atualizado: Origin.closingDay (Int), Origin.billingRolloverPolicy (NEXT|PREVIOUS), Expense.billingMonth (YYYY-MM) + √≠ndice @@index([userId, billingMonth])",
          "‚úÖ Helpers implementados: deriveBillingMonth(txDate, closingDay, policy) e adjustToBusinessDay() em backend/src/utils/billingHelpers.ts com 235 linhas de JSDoc",
          "‚úÖ API atualizada: POST/PUT /api/expenses calculam billingMonth automaticamente; GET /api/expenses?mode=billing&month=YYYY-MM funcional",
          "‚úÖ Valida√ß√£o 422: Retorna erro se cart√£o n√£o tem closingDay configurado",
          "‚úÖ Backfill: Script backend/scripts/backfill-billing-month.ts (152 linhas) para preencher billingMonth retroativo",
          "‚úÖ Redis: Cache por billingMonth integrado; invalida√ß√£o em muta√ß√µes",
          "‚úÖ Docker: Build est√°vel com enum atualizado (NEXT/PREVIOUS)",
          "‚úÖ Testes: billing.test.ts atualizado para novos valores de enum",
          "‚úÖ Documenta√ß√£o completa: MILESTONE_0_COMPLETE.md com 600+ linhas detalhando implementa√ß√£o",
          "‚úÖ Script de migra√ß√£o: migrate-billing-enum.ts criado para converter dados antigos",
          "‚úÖ Migra√ß√£o executada: 5 cart√µes atualizados de PREVIOUS_BUSINESS_DAY ‚Üí PREVIOUS no MongoDB",
          "‚úÖ Dockerfile atualizado: scripts/ e package.json copiados para runtime",
          "‚úÖ API Backend: GET /api/origins funcionando sem erros de enum",
          "‚úÖ Frontend atualizado: schemas.ts, types/index.ts e Cadastros.jsx com NEXT/PREVIOUS",
          "‚úÖ Guia de migra√ß√£o: MIGRATION_ENUM_BILLING.md com 250+ linhas e checklist completo",
          "üü° Frontend pendente: useExpenses mode=billing e UI de agrupamento por fatura (Todo #8)"
        ]
      },
      {
        "id": 14,
        "tag": "[Resilience] Dead Letter Queue (DLQ)",
        "status": "üü° Planejado (NOVO)",
        "summary": "Segregar mensagens irrecuper√°veis para an√°lise e reprocessamento seguro.",
        "notes": [
          "DLQ acoplada √† recurring-jobs; nack com requeue=false em erros permanentes.",
          "M√©tricas b√°sicas de taxa de dead-letter.",
          "Crit√©rios de aceite: mensagens inv√°lidas n√£o travam a fila principal.",
          "Riscos: descarte indevido; mitigar com policies e reten√ß√£o tempor√°ria."
        ]
      },
      {
        "id": 15,
        "tag": "[Refactor] Service/Repository Layer",
        "status": "üü° Planejado (NOVO)",
        "summary": "Separar responsabilidades em tr√™s camadas para clareza, testes e evolu√ß√£o segura.",
        "notes": [
          "Routes: valida√ß√£o + orquestra√ß√£o; Services: regras; Repositories: Prisma-only.",
          "Inje√ß√£o de depend√™ncia para facilitar mocks nos testes.",
          "Crit√©rios de aceite: rotas finas; services sem import de Prisma.",
          "Riscos: refator parcelado; mitigar com feature toggles e su√≠te de testes (#16)."
        ]
      },
      {
        "id": 13,
        "tag": "[Security] Auth httpOnly Cookies",
        "status": "üü° Planejado (NOVO)",
        "summary": "Trocar armazenamento de tokens para cookies httpOnly/sameSite, reduzindo superf√≠cie XSS.",
        "notes": [
          "Login entrega JWT via cookie httpOnly; logout limpa cookie.",
          "Axios withCredentials; refresh token seguro; access em mem√≥ria.",
          "Crit√©rios de aceite: rotas autenticadas funcionam sem localStorage.",
          "Riscos: CORS e dom√≠nio; mitigar com configura√ß√£o rigorosa e ambiente controlado."
        ]
      },
      {
        "id": 18,
        "tag": "[Security] Autentica√ß√£o Avan√ßada (MFA + Google Login)",
        "status": "üü° Planejado (NOVO)",
        "summary": "Adicionar MFA via Resend (OTP) e login social Google OAuth2 com fluxo completo de tokens.",
        "notes": [
          "Rotas: /auth/register, /auth/login, /auth/refresh, /auth/logout, /auth/resend, /auth/google.",
          "Cookies httpOnly para refresh; access token em mem√≥ria; interceptors Axios.",
          "Front: MFAForm e bot√£o Google; backend: valida√ß√µes de estado/nonce.",
          "Crit√©rios de aceite: MFA opcional funcional; Google login end-to-end.",
          "Riscos: fluxo OAuth mal configurado; mitigar com testes em sandbox e logs detalhados."
        ]
      },
      {
        "id": 5,
        "tag": "[API] √çndices e filtros UTC",
        "status": "üü¢ Implementado",
        "summary": "Normalizar consultas mensais por UTC para evitar desvios de timezone.",
        "notes": [
          "@@index([userId, date]) e range por Date.UTC em filtros.",
          "Crit√©rios de aceite: mesma query retorna os mesmos itens independente de TZ do host.",
          "Riscos: dados legados com TZ local; mitigado por convers√£o centralizada."
        ]
      },
      {
        "id": 6,
        "tag": "[FE] MUI Only Theme",
        "status": "üü¢ Implementado",
        "summary": "Unificar design system em MUI e remover res√≠duos de Tailwind.",
        "notes": [
          "ThemeProvider central; paleta/tipografia padronizadas.",
          "Crit√©rios de aceite: nenhuma classe Tailwind ativa; UI consistente.",
          "Riscos: regress√µes visuais; mitigar com verifica√ß√£o manual das principais telas."
        ]
      },
      {
        "id": 7,
        "tag": "[FE] Hooks Tipados + Query Cache",
        "status": "üü¢ Conclu√≠do",
        "summary": "Refatorar useFinanceApp em hooks modulares com TanStack Query e servi√ßos REST tipados.",
        "notes": [
          "useExpenses/useCatalogs/useSalary + Query Keys centralizadas.",
          "Axios com interceptors; tipagem de payloads/DTOs.",
          "Crit√©rios de aceite: cache por m√™s, invalida√ß√£o ap√≥s muta√ß√µes; zero acesso a LocalStorage.",
          "Riscos: chaves inconsistentes; mitigado por queryKeys.ts."
        ]
      },
      {
        "id": 8,
        "tag": "[FE/BE] Navega√ß√£o mensal + Cache Redis + Build Estabilizado",
        "status": "üü¢ Conclu√≠do (Valida√ß√£o Final OK)",
        "summary": "UX de navega√ß√£o temporal suave, cache distribu√≠do Redis e build Docker multi-stage est√°vel com Prisma.",
        "notes": [
          "MonthNavigator com Framer Motion; integra√ß√£o useFinanceApp.",
          "Upstash Redis por usu√°rio/m√™s e invalidation p√≥s-mutation.",
          "Docker: prisma generate no builder; c√≥pia de .prisma para runtime.",
          "Crit√©rios de aceite: logs com [CACHE HIT/MISS]; containers healthy.",
          "Riscos: WSL1; mitigar executando build em WSL2/Docker."
        ]
      },
      {
        "id": 4,
        "tag": "[Worker] RabbitMQ Robustness",
        "status": "üü¢ Conclu√≠do",
        "summary": "Resili√™ncia no processamento ass√≠ncrono de jobs de recorr√™ncia.",
        "notes": [
          "Reconex√£o com backoff, prefetch(10), ConfirmChannel, shutdown limpo.",
          "Crit√©rios de aceite: worker permanece est√°vel em reconex√µes.",
          "Riscos: mensagens venenosas; mitiga√ß√£o futura com DLQ (#14)."
        ]
      },
      {
        "id": 3,
        "tag": "[API] Security & Config ENV",
        "status": "üü¢ Conclu√≠do",
        "summary": "Endurecer configura√ß√£o e headers de seguran√ßa na API.",
        "notes": [
          "Zod para ENVs cr√≠ticos; Helmet e CORS din√¢mico.",
          "Crit√©rios de aceite: boot falha sem ENVs; headers presentes.",
          "Riscos: CORS mal configurado; mitigar com allowlist por ambiente."
        ]
      },
      {
        "id": 2,
        "tag": "[DB] Float ‚Üí String precision",
        "status": "üü¢ Conclu√≠do",
        "summary": "Evitar erros de arredondamento em valores monet√°rios.",
        "notes": [
          "Valores monet√°rios como string + coer√ß√µes nos helpers.",
          "Crit√©rios de aceite: compara√ß√£o monet√°ria determin√≠stica.",
          "Riscos: parsing negligenciado; mitigado em helpers centralizados."
        ]
      },
      {
        "id": 1,
        "tag": "[BUG] Replica√ß√£o e idempot√™ncia",
        "status": "üü¢ Resolvido",
        "summary": "Eliminar duplica√ß√µes de recorrentes por meio de fingerprint √∫nico.",
        "notes": [
          "√çndice √∫nico por fingerprint + backfill idempotente.",
          "Crit√©rios de aceite: nenhuma duplicidade em replays.",
          "Riscos: colis√£o de fingerprint; mitigado com sal e campos chave."
        ]
      }
    ],
    "last_action": "Sess√£o 09/11/2025: Milestone #13 (Auth httpOnly Cookies) conclu√≠da - Sistema de autentica√ß√£o completamente refatorado com cookies httpOnly + tokens em mem√≥ria. Access token (15min) em mem√≥ria, refresh token (7d) em cookie inacess√≠vel via JS. Auto-refresh, logout seguro, valida√ß√£o real de credenciais, logs audit√°veis. 100% testado e documentado (1000+ linhas README).",
    "session_achievements": [
      "‚úÖ Milestone #13: Autentica√ß√£o segura com cookies httpOnly implementada",
      "‚úÖ Backend: 4 endpoints (login, register, refresh, logout) com bcrypt + JWT",
      "‚úÖ Access Token: 15min em mem√≥ria (state) | Refresh Token: 7d em cookie httpOnly",
      "‚úÖ Cookies: httpOnly (previne XSS), secure (HTTPS prod), sameSite: strict (previne CSRF)",
      "‚úÖ CORS: credentials: true + withCredentials no axios",
      "‚úÖ cookie-parser@1.4.6 instalado no backend",
      "‚úÖ Frontend: Token em mem√≥ria, auto-refresh em 401, logout com backend",
      "‚úÖ Valida√ß√£o real: bcrypt.compare() + mensagens gen√©ricas (previne enumera√ß√£o)",
      "‚úÖ Logs seguros: Login/logout com email/IP (SEM senha/token)",
      "‚úÖ Testes: register, login, refresh, logout - TODOS PASSANDO",
      "‚úÖ Documenta√ß√£o: 1000+ linhas no README com diagramas ASCII e troubleshooting",
      "‚úÖ Breaking change: localStorage removido (usu√°rios devem fazer login novamente)"
    ],
    "next_steps": [
      "Implementar Milestone #0 frontend: UI de faturas com mode=billing e agrupamento",
      "Milestone #14: Dead Letter Queue para jobs falhados (resili√™ncia)",
      "Milestone #15: Service/Repository Layer (separar l√≥gica de neg√≥cio das rotas)",
      "Milestone #16: Testes automatizados (Jest + Supertest para APIs + RTL para frontend)",
      "Milestone #17: Storybook para componentes MUI",
      "Milestone #18: Autentica√ß√£o avan√ßada (MFA, Google OAuth)"
    ],
    "commit_template": "‚Ä¢ [Feature/Refactor/Fix] Descri√ß√£o da mudan√ßa.\n‚Ä¢ Relacionado ao(s) Milestone(s): #[ID]"
  }
}
